<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: util/CommandLoader.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: util/CommandLoader.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>
const fsX = require('fs-extra');
const EventEmitter = require('events').EventEmitter;
const path = require('path');
const clearRequire = require('clear-require');

/**
 * @typedef {Object|Function} Command - Structure of exported commands.  Can also be a single function.
 * @property {Iterable&lt;Trigger>|Trigger} triggers
 * @property {boolean} [disabled] - Whether the command is globally disabled
 * @property {CommandExecutor} func - The command function to execute.
 * @property {Validator} [validator] - Function to call to determine whether the command is valid.
 * @property {boolean} [respond] - Whether to automatically send the CommandExecutor response to the channel the command was sent in.
 */

/**
 * @typedef {String|RegExp} Trigger - A command trigger.
 */

/**
 * @typedef {Object} Config - Structure of command handler options.
 * @property {Array&lt;String>} [prefixes] - Prefixes to use, if any.
 * @property {String} [directory] - Where your command files are located; defaults to `./commands`
 * @property {Validator} [validator] - Valid command forms (defaults to prefixed).
 * @property {boolean} [respond] - Whether to automatically send the CommandExecutor response to the channel the command was sent in.
 * @property {boolean} [ignoreInvalid] - Whether to internally ignore invalid command errors.
 */

/**
 * @typedef {Function} Validator - Structure of any validator functions.
 * @param {Message} message
 * @param {Array} [args] - Args are only passed to command-level validators.
 * @returns {ResolvedContent}
 */

/**
 * @typedef {Function} CommandExecutor - Structure of any command execution functions.
 * @param {Message} message
 * @param {Array} args
 * @param {CommandMessage} handler
 * @returns {*} - The result of the command.
 */

/**
 * @typedef {String|null} ResolvedContent - Message content without any prefixes, null if invalid.
 */

/**
 * Manage command loading.
 *
 * @param {Config} config
 * @extends EventEmitter
 * @constructor
 */
class CommandLoader extends EventEmitter   {

    constructor(config = {}) {
        super();

        this.config = config;
        if(!this.config.prefixes) this.config.prefixes = [];
        if(!this.config.directory) this.config.directory = './commands';

        this.loadCommands();
    }

    /**
     * Load all commands into memory.  Use when reloading commands.
     *
     * @fires CommandLoader#commandsLoaded
     * @returns {Promise.&lt;Map.&lt;Trigger, Command>>}
     */
    loadCommands() {
        this.commands = new Map();
        return new Promise((resolve, reject) => {
            const files = [];
            const walker = fsX.walk(this.config.directory);

            walker.on('data', (data) => {
                if(data.stats.isFile() &amp;&amp; path.extname(data.path) === '.js') files.push(data.path);
            });

            walker.on('errors', err => reject(err));
            walker.on('end', () => resolve(files));
        }).then(files => {
            const failed = [];
            for(const file of files)    {

                try {
                    clearRequire(file);

                    /**
                     * @type {Command}
                     */
                    const mod = require(file);
                    if (mod.disabled === true) continue;

                    // if triggers are iterable
                    if (mod.triggers &amp;&amp; typeof mod.triggers[Symbol.iterator] === 'function' &amp;&amp; typeof mod.triggers !== 'string' &amp;&amp; !(mod.triggers instanceof RegExp)) {
                        for (const trigger of mod.triggers)  this.commands.set(trigger, mod);

                    } else if (typeof mod === 'function') { // if a single function is exported
                        this.commands.set(path.basename(file, '.js'), {func: mod});
                    } else if (typeof mod.triggers === 'undefined') {   // if no triggers are provided
                        this.commands.set(path.basename(file, '.js'), mod);
                    } else  {
                        this.commands.set(mod.triggers, mod);
                    }
                }   catch(e)    {
                    failed.push(file);
                }
            }

            /**
             * @event CommandLoader#commandsLoaded
             * @type {object}
             * @property {Map&lt;Trigger, Command>} commands - Currently loaded commands.
             * @property {Array} failed - Directory listing of commands that failed to load.
             */
            this.emit('loaded', {commands: this.commands, failed});
        });
    }
}

module.exports = CommandLoader;</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="CommandLoader.html">CommandLoader</a></li><li><a href="CommandMessage.html">CommandMessage</a></li><li><a href="InvalidCommand.html">InvalidCommand</a></li><li><a href="NotACommand.html">NotACommand</a></li></ul><h3>Events</h3><ul><li><a href="CommandLoader.html#event:commandsLoaded">commandsLoaded</a></li><li><a href="CommandMessage.html#event:commandFailed">commandFailed</a></li><li><a href="CommandMessage.html#event:commandFinished">commandFinished</a></li><li><a href="CommandMessage.html#event:commandStarted">commandStarted</a></li></ul><h3><a href="global.html">Global</a></h3>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.3</a> on Mon Jan 09 2017 20:40:50 GMT-0800 (Pacific Standard Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
