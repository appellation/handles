<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>CommandLoader.js - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="Argument.html">Argument</a><ul class='methods'><li data-type='method'><a href="Argument.html#resolver">resolver</a></li><li data-type='method'><a href="Argument.html#setOptional">setOptional</a></li><li data-type='method'><a href="Argument.html#setPrompt">setPrompt</a></li><li data-type='method'><a href="Argument.html#setResolver">setResolver</a></li></ul></li><li><a href="CommandLoader.html">CommandLoader</a><ul class='methods'><li data-type='method'><a href="CommandLoader.html#loadCommands">loadCommands</a></li></ul></li><li><a href="CommandMessage.html">CommandMessage</a><ul class='methods'><li data-type='method'><a href="CommandMessage.html#resolveArgs">resolveArgs</a></li><li data-type='method'><a href="CommandMessage.html#validate">validate</a></li></ul></li><li><a href="CommandResolver.html">CommandResolver</a><ul class='methods'><li data-type='method'><a href="CommandResolver.html#resolve">resolve</a></li></ul></li><li><a href="Handles.html">Handles</a><ul class='methods'><li data-type='method'><a href="Handles.html#handle">handle</a></li></ul></li><li><a href="Prompter.html">Prompter</a><ul class='methods'><li data-type='method'><a href="Prompter.html#awaitResponse">awaitResponse</a></li><li data-type='method'><a href="Prompter.html#collectPrompt">collectPrompt</a></li></ul></li><li><a href="Response.html">Response</a><ul class='methods'><li data-type='method'><a href="Response.html#dm">dm</a></li><li data-type='method'><a href="Response.html#error">error</a></li><li data-type='method'><a href="Response.html#send">send</a></li><li data-type='method'><a href="Response.html#success">success</a></li></ul></li><li><a href="Validator.html">Validator</a><ul class='methods'><li data-type='method'><a href="Validator.html#apply">apply</a></li></ul></li></ul><h3>Events</h3><ul><li><a href="CommandLoader.html#event:commandsLoaded">commandsLoaded</a></li><li><a href="CommandMessage.html#event:argumentsError">argumentsError</a></li><li><a href="CommandMessage.html#event:argumentsLoaded">argumentsLoaded</a></li><li><a href="CommandMessage.html#event:commandFailed">commandFailed</a></li><li><a href="CommandMessage.html#event:commandFinished">commandFinished</a></li><li><a href="CommandMessage.html#event:commandInvalid">commandInvalid</a></li><li><a href="CommandMessage.html#event:commandStarted">commandStarted</a></li><li><a href="Handles.html#event:commandUnknown">commandUnknown</a></li></ul><h3><a href="global.html">Global</a></h3>
</nav>

<div id="main">
    
    <h1 class="page-title">CommandLoader.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>const fs = require('fs');
const EventEmitter = require('events');
const path = require('path');
const clearRequire = require('clear-require');

/**
 * Manage command loading.
 * @param {Config} config - Configuration options for the command handler.
 * @extends {EventEmitter}
 * @constructor
 */
class CommandLoader extends EventEmitter   {

    constructor(config = {}) {
        super();

        /**
         * Configuration for handles.
         * @type {Config}
         */
        this.config = config;

        this.loadCommands();
    }

    /**
     * Load all commands into memory.  Use when reloading commands.
     *
     * @fires CommandLoader#commandsLoaded
     * @returns {Promise.&lt;Map.&lt;Trigger, Command>>}
     */
    loadCommands() {
        /**
         * Currently loaded commands.
         * @type {Map&lt;Trigger, Command>}
         */
        this.commands = new Map();
        return this._loadDir(this.config.directory).then(files => {
            const failed = [];
            for(const file of files)    {

                /**
                 * @type {Command}
                 */
                let mod;
                const location = path.resolve(process.cwd(), file);

                try {
                    clearRequire(location);
                    mod = require(location);
                }   catch(e)    {
                    failed.push(file);
                    console.error(e); // eslint-disable-line no-console
                    continue;
                }

                if (mod.disabled === true) continue;

                // if triggers are iterable
                if (mod.triggers &amp;&amp; typeof mod.triggers[Symbol.iterator] === 'function' &amp;&amp; typeof mod.triggers !== 'string' &amp;&amp; !(mod.triggers instanceof RegExp)) {
                    for (const trigger of mod.triggers)  this.commands.set(trigger, mod);

                } else if (typeof mod === 'function') { // if a single function is exported
                    this.commands.set(path.basename(file, '.js'), Object.assign(mod,{func: mod}));
                } else if (typeof mod.triggers === 'undefined') {   // if no triggers are provided
                    this.commands.set(path.basename(file, '.js'), mod);
                } else  {
                    this.commands.set(mod.triggers, mod);
                }
            }

            /**
             * @event CommandLoader#commandsLoaded
             * @type {Object}
             * @property {Map&lt;Trigger, Command>} commands - Currently loaded commands.
             * @property {Array} failed - Directory listing of commands that failed to load.
             */
            this.emit('commandsLoaded', {commands: this.commands, failed});
        });
    }

    _loadDir(dir) {
        return new Promise((resolve, reject) => {
            fs.readdir(dir, (err, files) => {
                if(err) return reject(err);

                const loading = [];
                const list = [];

                for(const f of files) {
                    const currentPath = path.join(dir, f);

                    loading.push(
                        new Promise((resolve, reject) => {
                            fs.stat(currentPath, (err, stat) => {
                                if(err) return reject(err);

                                if(stat.isFile() &amp;&amp; path.extname(currentPath) === '.js') {
                                    list.push(currentPath);
                                    resolve();
                                } else if(stat.isDirectory()) {
                                    this._loadDir(currentPath).then(files => {
                                        list.push(...files);
                                        resolve();
                                    });
                                } else {
                                    resolve();
                                }
                            });
                        }).catch(console.error) // eslint-disable-line no-console
                    );
                }
                return Promise.all(loading).then(() => resolve(list));
            });
        });
    }
}

module.exports = CommandLoader;
</code></pre>
        </article>
    </section>




</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.3</a> on Sun Apr 23 2017 16:55:02 GMT-0700 (Pacific Daylight Time) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
